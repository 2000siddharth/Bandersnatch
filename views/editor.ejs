<html>
<title>ok</title>
<head>

  <label>Theme</label>
  <select id = "th" onchange = "changeTheme();">
    <option value = "1"> yonce </option>
    <option value = "2"> dracula </option>
    <option value = "3"> zenburn </option>
    <option value = "4"> seti </option>
    <option value = "5"> the-matrix </option>
    <option value = "6"> neo </option>
  </select>

  <link id ='theme' href="https://cdn.jsdelivr.net/npm/codemirror@5.57.0/theme/yonce.css" rel = "stylesheet"/>
</head>
<body>
  <h3>Write Your Code Here</h3>
  <textarea id="txt"></textarea>
  <br></br>
  <label>Users Joined</label>
  <ul id = "listOfUsers"></ul>
</body>
<script src ="https://cdn.jsdelivr.net/npm/codemirror@5.57.0/lib/codemirror.js"></script>
<script src ="https://cdn.jsdelivr.net/npm/codemirror@5.57.0/mode/xml/xml.js"></script>
<script src ="https://cdn.jsdelivr.net/npm/codemirror@5.57.0/addon/edit/closetag.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.57.0/lib/codemirror.css">
<script src ="/socket.io/socket.io.js"></script>
<script>

  let editor = CodeMirror.fromTextArea(document.getElementById('txt'),{
    mode : 'xml',
    theme : 'yonce',
    lineNumbers : true,
    autoCloseTags : true,
  });

  let getParams = function (url) {
	let params = {};
	let parser = document.createElement('a');
	parser.href = url;
	let query = parser.search.substring(1);
	let vars = query.split('&');
	for (let i = 0; i < vars.length; i++) {
		let pair = vars[i].split('=');
		params[pair[0]] = decodeURIComponent(pair[1]);
	}
	return params;
};

  let params =getParams(window.location.href);

  let socket = io.connect();
  socket.emit('join', params);
  CodeMirror.on(editor, "change", (instance, change) => {
      socket.emit('send message', change['text'], change['removed'], change['from'],params['id']);
  });

  editor.setSize('1000','500');

  function changeTheme() {
    let selectedOption = document.getElementById("th");
    let theme = selectedOption.options[selectedOption.selectedIndex].text;
    let path = "https://cdn.jsdelivr.net/npm/codemirror@5.57.0/theme/";
    path = path.concat(theme,".css");
    document.getElementById('theme').href = path;
    editor.setOption('theme', theme);
  }

  socket.on('new message', data => {
    console.log(data);
  })

  socket.on('userJoined', nameOfUsers => {
      document.getElementById('listOfUsers').textContent='';

      for(let i = 0; i<nameOfUsers.length; i++) {
        let node = document.createElement("LI");
        let user = document.createTextNode(nameOfUsers[i]['name']);
        console.log(user);
        node.appendChild(user);
        document.getElementById('listOfUsers').appendChild(node);
      }
  })
</script>
</html>
