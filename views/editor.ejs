<html>
<title>ok</title>
<head>

</head>
<body>
  <h3>Write Your Code Here</h3>
  <div id="editor" style = "height: 400px"></div>
  <br></br>
  <label>Users Joined</label>
  <ul id = "listOfUsers"></ul>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
</body>
<script src ="/socket.io/socket.io.js"></script>
<script>

  let editor = new Quill("#editor",{
    theme : "snow"
  });

  let getParams = function (url) {
	let params = {};
	let parser = document.createElement('a');
	parser.href = url;
	let query = parser.search.substring(1);
	let vars = query.split('&');
	for (let i = 0; i < vars.length; i++) {
		let pair = vars[i].split('=');
		params[pair[0]] = decodeURIComponent(pair[1]);
	}
	return params;
};

  let params =getParams(window.location.href);

  let socket = io.connect();
  socket.emit('join', params);
  editor.on("text-change", (delta,oldDelta,source) => {

      if(source =='api')
        return;
        
      let index, inserted, deleted;

      if(delta['ops'].length == 1){
        index = 0;
        inserted = delta['ops'][0]['insert'];
        deleted = delta['ops'][0]['delete'];
      }
      else{
        index = delta['ops'][0]['retain'];
        inserted = delta['ops'][1]['insert'];
        deleted = delta['ops'][1]['delete'];
      }
      socket.emit('send message', inserted, deleted, index ,params['id']);
  });


/*  function changeTheme() {
    let selectedOption = document.getElementById("th");
    let theme = selectedOption.options[selectedOption.selectedIndex].text;
    let path = "https://cdn.jsdelivr.net/npm/codemirror@5.57.0/theme/";
    path = path.concat(theme,".css");
    document.getElementById('theme').href = path;
    editor.setOption('theme', theme);
  }
*/
  socket.on('new message', data => {
    if(data['delete']==null)
      editor.insertText(data['index'], data['insert']);
    else
      editor.deleteText(data['index'],data['delete']);
  })

  socket.on('userJoined', nameOfUsers => {
      document.getElementById('listOfUsers').textContent='';

      for(let i = 0; i<nameOfUsers.length; i++) {
        let node = document.createElement("LI");
        let user = document.createTextNode(nameOfUsers[i]['name']);
        node.appendChild(user);
        document.getElementById('listOfUsers').appendChild(node);
      }
  })
</script>
</html>
