<html>
<title>ok</title>
<head>
  <link rel="stylesheet" href="./codemirror/lib/codemirror.css">
  <script src="./codemirror/lib/codemirror.js"></script>
  <script src="./codemirror/mode/xml/xml.js"></script>
  <script src="./codemirror/addon/edit/closetag.js"></script>
  <script src ="/socket.io/socket.io.js"></script>

  <label>Theme</label>
  <select id = "th" onchange = "changeTheme();">
    <option value = "1"> yonce </option>
    <option value = "2"> dracula </option>
    <option value = "3"> zenburn </option>
    <option value = "4"> seti </option>
    <option value = "5"> the-matrix </option>
    <option value = "6"> neo </option>
  </select>

  <link id ='theme' href="./codemirror/theme/yonce.css" rel = "stylesheet"/>
</head>
<body>
  <h3>Write Your Code Here</h3>
  <textarea id="txt"></textarea>
</body>
<script>

  let socket;

  function f() {
    socket = io.connect();
  }
  f();

  let editor = CodeMirror.fromTextArea(document.getElementById('txt'),{
    mode : 'xml',
    theme : 'yonce',
    lineNumbers : true,
    autoCloseTags : true,
  });
  let id = [0,0];
  CodeMirror.on(editor, "change", (instance, change) => {
      socket.emit('send message', change['text'], change['removed'], change['from']);
      if(change['txt'] === ["", ""])
        id[0]+=1;
      id[1]+=1;
  });

  editor.setSize('1000','500');

  function changeTheme() {
    let selectedOption = document.getElementById("th");
    //console.log(selectedOption);
    let theme = selectedOption.options[selectedOption.selectedIndex].text;
    let path = "./codemirror/theme/";
    path = path.concat(theme,".css");
    document.getElementById('theme').href = path;
    editor.setOption('theme', theme);
  }

  let ch = 0;
  socket.on('new message', data => {
    console.log(data);
    //editor.off("change", (editor, change) => console.log('Turned off event'));
    if(data['index']['line']<id[0])
        editor.replaceRange("\n", {'line' : id[0] , 'ch': id[1]});
    else if(data['index']['line']>=id[0] && data['index']['ch']>=id[1])
    editor.replaceRange(data['msg'][0],{'line' : data['index']['line'] , 'ch': data['index']['ch']});
    //editor.off("change", (editor, change) => console.log('Turned off event'));
  });
</script>
</html>
